<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.campuslostsearch.mapper.ItemMapper">
    <insert id="insertLostItem" parameterType="LostItem">
        INSERT INTO lost_item (
            lost_item_id, user_id, category_id, item_name,
            description, location, lost_time, status, create_time
        ) VALUES (
            #{lostItemId}, #{userId}, #{categoryId}, #{itemName},
            #{description}, #{location}, #{lostTime}, #{status}, #{createTime}
        )
    </insert>
    
    <insert id="insertFoundItem" parameterType="FoundItem">
        INSERT INTO found_item (
            found_item_id, user_id, category_id, item_name,
            description, location, found_time, status, create_time
        ) VALUES (
            #{foundItemId}, #{userId}, #{categoryId}, #{itemName},
            #{description}, #{location}, #{foundTime}, #{status}, #{createTime}
        )
    </insert>
    
    <resultMap id="LostItemResultMap" type="LostItem">
        <id property="lostItemId" column="lost_item_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="itemName" column="item_name"/>
        <result property="description" column="description"/>
        <result property="location" column="location"/>
        <result property="lostTime" column="lost_time"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <resultMap id="FoundItemResultMap" type="FoundItem">
        <id property="foundItemId" column="found_item_id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="itemName" column="item_name"/>
        <result property="description" column="description"/>
        <result property="location" column="location"/>
        <result property="foundTime" column="found_time"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <select id="findLostItems" resultMap="LostItemResultMap">
        SELECT l.*, c.name as category_name, u.username
        FROM lost_item l
        JOIN category c ON l.category_id = c.category_id
        JOIN user u ON l.user_id = u.user_id
        WHERE 1=1
        <if test="categoryId != null">
            AND l.category_id = #{categoryId}
        </if>
        <if test="keyword != null">
            AND (l.item_name LIKE CONCAT('%',#{keyword},'%') 
                 OR l.description LIKE CONCAT('%',#{keyword},'%')
                 OR l.location LIKE CONCAT('%',#{keyword},'%'))
        </if>
        <if test="status != null">
            AND l.status = #{status}
        </if>
        ORDER BY l.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="findFoundItems" resultMap="FoundItemResultMap">
        SELECT f.*, c.name as category_name, u.username
        FROM found_item f
        JOIN category c ON f.category_id = c.category_id
        JOIN user u ON f.user_id = u.user_id
        WHERE 1=1
        <if test="categoryId != null">
            AND f.category_id = #{categoryId}
        </if>
        <if test="keyword != null">
            AND (f.item_name LIKE CONCAT('%',#{keyword},'%') 
                 OR f.description LIKE CONCAT('%',#{keyword},'%')
                 OR f.location LIKE CONCAT('%',#{keyword},'%'))
        </if>
        <if test="status != null">
            AND f.status = #{status}
        </if>
        ORDER BY f.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="countLostItems" resultType="Long">
        SELECT COUNT(*)
        FROM lost_item
        WHERE 1=1
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="keyword != null">
            AND (item_name LIKE CONCAT('%',#{keyword},'%') 
                 OR description LIKE CONCAT('%',#{keyword},'%')
                 OR location LIKE CONCAT('%',#{keyword},'%'))
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>
    
    <select id="countFoundItems" resultType="Long">
        SELECT COUNT(*)
        FROM found_item
        WHERE 1=1
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="keyword != null">
            AND (item_name LIKE CONCAT('%',#{keyword},'%') 
                 OR description LIKE CONCAT('%',#{keyword},'%')
                 OR location LIKE CONCAT('%',#{keyword},'%'))
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>
</mapper> 